# Co-Maintainer: Achill Gilgenast <achill@achill.org>
maintainer="Aelin <aelin@postmarketos.org>"
pkgname=linux-postmarketos-lts
pkgver=6.18.14
pkgrel=0
_kver=${pkgver%.*}
pkgdesc="LTS Kernel"
# armhf: pmbootstrap cannot dynamically choose a defconfig, so it ends up using multi_v7_defconfig which isn't correct
# s390x: kconfigcheck is not ready for it yet
arch="all !armhf !s390x"
_flavor="lts"
url="https://kernel.org"
license="GPL-2.0-only"
options="
	!check
	!strip
	!tracedeps
	pmb:cross-native
	pmb:generic-kernel
	pmb:kconfigcheck-community
	pmb:kconfigcheck-immutable
	pmb:kconfigcheck-rust
	pmb:kconfigcheck-uefi
	pmb:kconfigcheck-virt
"
makedepends="
	bison
	clang
	clang-libclang
	diffutils
	elfutils-dev
	findutils
	flex
	linux-headers
	lld
	llvm
	openssl-dev
	pahole
	perl
	postmarketos-installkernel
	python3
	rust
	rust-bindgen
	rust-src
	rustfmt
	sed
	zstd
"
replaces="linux-lts"

# Source
source="
	linux-$_kver.tar.xz::https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$_kver.tar.xz

	config-lts.aarch64
	config-lts.armv7
	config-lts.loongarch64
	config-lts.ppc64le
	config-lts.riscv64
	config-lts.x86
	config-lts.x86_64
"
builddir="$srcdir/linux-$_kver"
_defconfig="defconfig"

if [ "${pkgver%.0}" = "$pkgver" ]; then
	# Prepend to apply first
	source="patch-$pkgver.patch.xz::https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/patch-$pkgver.xz $source"
fi

case "$CARCH" in
	aarch64*) _carch="arm64" ;;
	arm*) _carch="arm" ;;
	loongarch*) _carch="loongarch" ;;
	ppc*) _carch="powerpc" ;;
	riscv*) _carch="riscv" ;;
	s390x) _carch="s390" ;;
	x86) _carch="i386" ;;
	x86_64) _carch="x86_64" ;;
esac

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$CARCH" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" LLVM=1 \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-$_flavor"
}

package() {
	local _install
	case "$CARCH" in
		arm*|aarch64|riscv*) _install="zinstall dtbs_install" ;;
		*) _install="install" ;;
	esac

	make modules_install $_install \
		ARCH="$_carch" \
		LLVM=1 \
		INSTALL_PATH="$pkgdir"/boot/ \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs

	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	install -D "$builddir"/include/config/kernel.release \
		"$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}

sha512sums="
ce9de7b957c67d3ff36838b5537457487aed4bf730a372979717af49cd3249cd7e6b32eb1719c7f2776392a42c0553f7d35be7948e05f7c0948b13822dcea3ae  patch-6.18.14.patch.xz
88599ffdec96d150c1feb9b261ba93bb0301a9d0e1ad6bef7aeab1f5372cbfc57d8b43c7e902bd8f76921d1dbd8189663c142ea869e51d0e2b483b150ee00fe0  linux-6.18.tar.xz
2b5ffd584d8b7ea05a3db6610e83a3a6fe5d840f19e09f77dac0bd2ecf8cf6c4301ad16c972eec75eaaa75add3c43a342f24ca82d1b9446eb7348cc970339e98  config-lts.aarch64
5e5ee60c082bb24296cbf238179edd7690ab570241b06668cf14a25c499113d0f32dbd5c16da80e852219eb778b1bd23594a6f675ab7fa503cb17471da3427fc  config-lts.armv7
0ed32a3a03a994fd245c49b90d3d88c8941d69e75e212ea14d17dbaf352414b3fc498aff25d4f4efccab2ac1058e9511abc21cd7ecd75ec179462ade799d0ef4  config-lts.loongarch64
8dc0d672f09e46f7b1d2961df80db0732c48a7e73f04eac25c96ceca52abd10ac4756a563469b51682492b6f34b04a572745ec45bb69b66aa29e57c6494092b1  config-lts.ppc64le
a1cfccae347a88de85b9653eadcc2c340fcab0fbca5e3aded1cbd65e48158d57c3008fb3a6a80461a82ce1d66b03417e80a5c0fb0d85f915d31f712ad9a9eedd  config-lts.riscv64
c6d40c741565a4c90d4cd123c0c32e1e946ca0177dd98fe346c482daaba02cd1a9dd2f43a25a055928a5eabb8da2065f980616085dc1e5109ba360c3f9ca45db  config-lts.x86
038c81372e73317e3b158c52b52ebe192b358072f5d93a089a384f21bb5827330b721dc1dc7ed4d5f65e7d5ecbe476048069f52600888685f73c1e442783a271  config-lts.x86_64
"
