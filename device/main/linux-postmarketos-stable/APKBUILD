# Co-Maintainer: Achill Gilgenast <achill@achill.org>
maintainer="Aelin <aelin@postmarketos.org>"
pkgname=linux-postmarketos-stable
pkgver=6.19.4
pkgrel=0
_kver=${pkgver%.*}
pkgdesc="Stable Kernel"
# armhf: pmbootstrap cannot dynamically choose a defconfig, so it ends up using multi_v7_defconfig which isn't correct
# s390x: kconfigcheck is not ready for it yet
arch="all !armhf !s390x"
_flavor="stable"
url="https://kernel.org"
license="GPL-2.0-only"
options="
	!check
	!strip
	!tracedeps
	pmb:cross-native
	pmb:generic-kernel
	pmb:kconfigcheck-community
	pmb:kconfigcheck-immutable
	pmb:kconfigcheck-rust
	pmb:kconfigcheck-uefi
	pmb:kconfigcheck-virt
"
makedepends="
	bison
	clang
	clang-libclang
	diffutils
	elfutils-dev
	findutils
	flex
	linux-headers
	lld
	llvm
	openssl-dev
	pahole
	perl
	postmarketos-installkernel
	python3
	rust
	rust-bindgen
	rust-src
	rustfmt
	sed
	zstd
"
replaces="linux-stable"

# Source
source="
	linux-$_kver.tar.xz::https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$_kver.tar.xz

	config-stable.aarch64
	config-stable.armv7
	config-stable.loongarch64
	config-stable.ppc64le
	config-stable.riscv64
	config-stable.x86
	config-stable.x86_64
"
builddir="$srcdir/linux-$_kver"
_defconfig="defconfig"

if [ "${pkgver%.0}" = "$pkgver" ]; then
	# Prepend to apply first
	source="patch-$pkgver.patch.xz::https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/patch-$pkgver.xz $source"
fi

case "$CARCH" in
	aarch64*) _carch="arm64" ;;
	arm*) _carch="arm" ;;
	loongarch*) _carch="loongarch" ;;
	ppc*) _carch="powerpc" ;;
	riscv*) _carch="riscv" ;;
	s390x) _carch="s390" ;;
	x86) _carch="i386" ;;
	x86_64) _carch="x86_64" ;;
esac

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$CARCH" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" LLVM=1 \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-$_flavor"
}

package() {
	local _install
	case "$CARCH" in
		arm*|aarch64|riscv*) _install="zinstall dtbs_install" ;;
		*) _install="install" ;;
	esac

	make modules_install $_install \
		ARCH="$_carch" \
		LLVM=1 \
		INSTALL_PATH="$pkgdir"/boot/ \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs

	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	install -D "$builddir"/include/config/kernel.release \
		"$pkgdir"/usr/share/kernel/$_flavor/kernel.release
}

sha512sums="
79cb9e9b3f9560bb3bf982a332f8ac59004fd0353a8fa5873b82913b19ca767d761c9563ee353d727dc21ad257c7a044257b1e65cd9e532b446ecc338b0dd728  patch-6.19.4.patch.xz
01b29c7f4e5bc0c9802794c2cd027fece825f90417be229a71e60eefce530010d5d301749c54ae744e9d4a483518e769e2bb7e6e9209687681ad7fff11c3ed86  linux-6.19.tar.xz
1e6383342b55fdc8f689d05f7fcff316b50a95aa82283a9239beada9f05a850f04b56c773bf428b455c06b767f37c855a3d08479129209847d799e480fcba4f5  config-stable.aarch64
1debe7d0b39ebbd74c5f4d88e4b74f5c77bdfe46c6301e35f7f429e3dd1987f72b0d77901584860c0b22fab4bf03f56adccb27d10a466c452e789a2a37e4678b  config-stable.armv7
6aabcef60a76b75131a533f3b312d9f7af68eccb124afd4e37081c5215679eb05773d1c67656e44e478a6eb3eea471fc85c385cb27293a93cffc710b72a86907  config-stable.loongarch64
a5094409e494cf7433cac2f45925b963bb668f83128d79ce6dc7efc1d94cd65bbdbbfa30eeff107030ecbf96998399b3918b1af85cac79776fc7e4f1bd95095c  config-stable.ppc64le
2d099f281af617b3fde110bc089eb641e8da322d395f80eda390cee0c5251f630ee9b24cc7d8b0fdbf5cfa8979236ec25f9a0b09e4d36a4134d4b96e8321e91a  config-stable.riscv64
f86d4db56daf1db6e51b2030e6619fa1c3b2bb2f7139d2b43669713eea0e2a2c3848622f8bd19aebda04512e07ab2253eb0e1ddf7793f96fc7ce1dad8ace5138  config-stable.x86
b2d374c4e003587095b0f2c7926109a78e19a7217d57cb1bd3a01c36db7a9d4a18f258abb23ac6cc8b68ea9020d625731caae1a1be4ea46b0f056d366fc15ced  config-stable.x86_64
"
