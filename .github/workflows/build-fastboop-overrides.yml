name: Build Fastboop Overrides

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - .github/workflows/build-fastboop-overrides.yml
      - .github/scripts/setup-pmbootstrap.sh
      - .github/scripts/publish-apk-repo.sh
      - .github/scripts/smoke-check-apk-repo.sh
      - main/postmarketos-usb-moded/**
      - device/testing/linux-postmarketos-qcom-msm8916/**
      - device/community/linux-postmarketos-qcom-sdm845/**

concurrency:
  group: build-fastboop-overrides-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-publish-check:
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 360
    env:
      APK_REPO_BASE_URL: ${{ vars.APK_REPO_BASE_URL || 'https://pmos.samcday.com' }}
      APK_REPO_KEY_URL: ${{ vars.APK_REPO_KEY_URL || 'https://pmos.samcday.com/pmos.samcday.com.rsa.pub' }}
      APK_REPO_BUCKET: ${{ vars.APK_REPO_BUCKET || 'samcday-pmos' }}
      APK_REPO_S3_ENDPOINT: ${{ vars.APK_REPO_S3_ENDPOINT || 'https://s3.eu-central-003.backblazeb2.com' }}
      APK_REPO_S3_REGION: ${{ vars.APK_REPO_S3_REGION || 'eu-central-003' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up pmbootstrap
        env:
          APK_REPO_SIGNING_KEY: ${{ secrets.APK_REPO_SIGNING_KEY }}
        run: bash .github/scripts/setup-pmbootstrap.sh oneplus-fajita phosh

      - name: Build selected override packages
        run: |
          python3 "$PMBOOTSTRAP" -y build_init
          python3 "$PMBOOTSTRAP" -y --details-to-stdout build --arch aarch64 --strict --force linux-postmarketos-qcom-msm8916
          python3 "$PMBOOTSTRAP" -y --details-to-stdout build --arch aarch64 --strict --force linux-postmarketos-qcom-sdm845
          python3 "$PMBOOTSTRAP" -y --details-to-stdout build --arch aarch64 --strict --force postmarketos-usb-moded

      - name: Collect built APKs
        run: |
          mkdir -p out/aarch64
          shopt -s nullglob
          files=()

          for pkg_dir in "$PMB_WORK/packages/edge/aarch64" "$PMB_WORK/packages/edge/noarch"; do
            files+=(
              "$pkg_dir"/linux-postmarketos-qcom-msm8916-*.apk
              "$pkg_dir"/linux-postmarketos-qcom-sdm845-*.apk
              "$pkg_dir"/postmarketos-usb-moded-*.apk
            )
          done

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No expected APK outputs found for linux-postmarketos-qcom-{msm8916,sdm845} and postmarketos-usb-moded"
            exit 1
          fi

          cp -f "${files[@]}" out/aarch64/

          tmp_keys_dir="$(mktemp -d)"
          matching_keys=()

          for key in "$PMB_WORK"/config_apk_keys/*.pub; do
            rm -f "${tmp_keys_dir}"/*.pub
            cp "${key}" "${tmp_keys_dir}/"

            for apk in "${files[@]}"; do
              if "$PMB_WORK"/apk.static --keys-dir "${tmp_keys_dir}" verify "${apk}" >/dev/null 2>&1; then
                matching_keys+=("${key}")
                break
              fi
            done
          done

          if [ "${#matching_keys[@]}" -eq 0 ]; then
            echo "Failed to determine package signing key(s)"
            rm -rf "${tmp_keys_dir}"
            exit 1
          fi

          for key in "${matching_keys[@]}"; do
            cp -f "${key}" out/aarch64/
          done

          primary_key="${PMB_WORK}/config_apk_keys/pmos.samcday.com.rsa.pub"

          if [ ! -f "${primary_key}" ]; then
            primary_key=""
            for key in "${matching_keys[@]}"; do
              if [[ "$(basename "${key}")" == pmos@local-* ]]; then
                primary_key="${key}"
                break
              fi
            done
          fi

          if [ -z "${primary_key}" ]; then
            primary_key="${matching_keys[0]}"
          fi

          rm -rf "${tmp_keys_dir}"

          cp -f "${primary_key}" out/aarch64/pmos.samcday.com.rsa.pub
          ls -lh out/aarch64/

      - name: Generate signed APKINDEX
        run: |
          set -euo pipefail

          packager_privkey="$(awk -F'"' '/^PACKAGER_PRIVKEY=/{print $2}' "${PMB_WORK}/config_abuild/abuild.conf")"

          if [ -z "${packager_privkey}" ]; then
            echo "Failed to resolve PACKAGER_PRIVKEY"
            exit 1
          fi

          key_basename="$(basename "${packager_privkey}")"
          host_key_path="${PMB_WORK}/config_abuild/${key_basename}"

          if [ ! -f "${host_key_path}" ]; then
            echo "Signing key not found: ${host_key_path}"
            exit 1
          fi

          docker run --rm \
            -v "${PWD}/out/aarch64:/repo" \
            -v "${host_key_path}:/keys/${key_basename}:ro" \
            -e "KEY_BASENAME=${key_basename}" \
            alpine:3.20 \
            /bin/sh -euxc 'apk add --no-cache alpine-sdk >/dev/null; cd /repo; apk index --allow-untrusted -o APKINDEX.tar.gz ./*.apk; abuild-sign -k "/keys/${KEY_BASENAME}" APKINDEX.tar.gz'

          openssl rsa -in "${host_key_path}" -pubout > out/aarch64/pmos.samcday.com.rsa.pub

          verify_keys_dir="$(mktemp -d)"
          cp out/aarch64/pmos.samcday.com.rsa.pub "${verify_keys_dir}/"
          "${PMB_WORK}/apk.static" --keys-dir "${verify_keys_dir}" verify out/aarch64/APKINDEX.tar.gz
          for apk in out/aarch64/*.apk; do
            "${PMB_WORK}/apk.static" --keys-dir "${verify_keys_dir}" verify "${apk}"
          done
          rm -rf "${verify_keys_dir}"

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fastboop-overrides-aarch64
          path: out/aarch64/

      - name: Install AWS CLI
        if: github.event_name == 'push'
        run: |
          if ! command -v aws >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y awscli
          fi

      - name: Publish hosted APK repo
        if: github.event_name == 'push'
        env:
          APK_REPO_ACCESS_KEY_ID: ${{ secrets.APK_REPO_ACCESS_KEY_ID }}
          APK_REPO_SECRET_ACCESS_KEY: ${{ secrets.APK_REPO_SECRET_ACCESS_KEY }}
        run: bash .github/scripts/publish-apk-repo.sh out/aarch64

      - name: Smoke check hosted APK repo
        if: github.event_name == 'push'
        env:
          APK_REPO_DOCKER_PLATFORM: linux/arm64/v8
        run: |
          set -euo pipefail

          for attempt in 1 2 3 4 5; do
            if bash .github/scripts/smoke-check-apk-repo.sh; then
              exit 0
            fi

            if [ "${attempt}" -eq 5 ]; then
              echo "Smoke check failed after ${attempt} attempts"
              exit 1
            fi

            echo "Smoke check attempt ${attempt} failed; waiting 20s before retry"
            sleep 20
          done
