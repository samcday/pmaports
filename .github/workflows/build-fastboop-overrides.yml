name: Build Fastboop Overrides

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - .github/workflows/build-fastboop-overrides.yml
      - .github/scripts/setup-pmbootstrap.sh
      - .github/scripts/publish-apk-repo.sh
      - .github/scripts/smoke-check-apk-repo.sh
      - main/postmarketos-usb-moded/**
      - device/testing/linux-postmarketos-qcom-msm8916/**
      - device/community/linux-postmarketos-qcom-sdm845/**

concurrency:
  group: build-fastboop-overrides-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  resolve-build-matrix:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.select.outputs.packages }}
      has_packages: ${{ steps.select.outputs.has_packages }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select packages from changed paths
        id: select
        env:
          BEFORE_SHA: ${{ github.event.before }}
        run: |
          set -euo pipefail

          before_sha="${BEFORE_SHA:-}"
          null_sha="0000000000000000000000000000000000000000"

          if [ "${before_sha}" = "null" ]; then
            before_sha=""
          fi

          if [ -n "${before_sha}" ] && [ "${before_sha}" != "${null_sha}" ] && git cat-file -e "${before_sha}^{commit}" 2>/dev/null; then
            changed_paths="$(git diff --name-only "${before_sha}" "${GITHUB_SHA}")"
          else
            changed_paths="$(git show --pretty='' --name-only "${GITHUB_SHA}")"
          fi

          if [ -z "${changed_paths}" ]; then
            echo "No changed paths detected from git history; falling back to full package set."
          else
            printf 'Changed paths:\n%s\n' "${changed_paths}"
          fi

          CHANGED_PATHS="${changed_paths}" python3 - <<'PY' > matrix.out
          import json
          import os

          paths = [line.strip() for line in os.environ.get("CHANGED_PATHS", "").splitlines() if line.strip()]

          all_packages = [
              "linux-postmarketos-qcom-msm8916",
              "linux-postmarketos-qcom-sdm845",
              "postmarketos-usb-moded",
          ]

          selected = []


          def add(pkg: str) -> None:
              if pkg not in selected:
                  selected.append(pkg)


          for path in paths:
              if path in {
                  ".github/workflows/build-fastboop-overrides.yml",
                  ".github/scripts/setup-pmbootstrap.sh",
                  ".github/scripts/publish-apk-repo.sh",
                  ".github/scripts/smoke-check-apk-repo.sh",
              }:
                  for pkg in all_packages:
                      add(pkg)

              if path.startswith("device/testing/linux-postmarketos-qcom-msm8916/"):
                  add("linux-postmarketos-qcom-msm8916")

              if path.startswith("device/community/linux-postmarketos-qcom-sdm845/"):
                  add("linux-postmarketos-qcom-sdm845")

              if path.startswith("main/postmarketos-usb-moded/"):
                  add("postmarketos-usb-moded")

          if not selected:
              selected = all_packages.copy()

          print(f"packages={json.dumps(selected)}")
          print("has_packages=true" if selected else "has_packages=false")
          PY

          cat matrix.out
          cat matrix.out >> "${GITHUB_OUTPUT}"

  build-overrides:
    needs: resolve-build-matrix
    if: needs.resolve-build-matrix.outputs.has_packages == 'true'
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.resolve-build-matrix.outputs.packages) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up pmbootstrap
        env:
          APK_REPO_SIGNING_KEY: ${{ secrets.APK_REPO_SIGNING_KEY }}
        run: bash .github/scripts/setup-pmbootstrap.sh oneplus-fajita phosh

      - name: Build selected override package
        run: |
          set -euo pipefail
          python3 "$PMBOOTSTRAP" -y build_init
          python3 "$PMBOOTSTRAP" -y --details-to-stdout build --arch aarch64 --strict --force "${{ matrix.package }}"

      - name: Collect built APKs
        run: |
          set -euo pipefail
          shopt -s nullglob

          artifact_dir="out/${{ matrix.package }}"
          mkdir -p "${artifact_dir}"

          patterns=()

          case "${{ matrix.package }}" in
            linux-postmarketos-qcom-msm8916)
              patterns+=("$PMB_WORK/packages/edge/aarch64/linux-postmarketos-qcom-msm8916-*.apk")
              ;;
            linux-postmarketos-qcom-sdm845)
              patterns+=("$PMB_WORK/packages/edge/aarch64/linux-postmarketos-qcom-sdm845-*.apk")
              ;;
            postmarketos-usb-moded)
              patterns+=("$PMB_WORK/packages/edge/noarch/postmarketos-usb-moded-*.apk")
              patterns+=("$PMB_WORK/packages/edge/aarch64/postmarketos-usb-moded-*.apk")
              ;;
            *)
              echo "Unsupported package selector: ${{ matrix.package }}"
              exit 1
              ;;
          esac

          files=()
          for pattern in "${patterns[@]}"; do
            for file in ${pattern}; do
              files+=("${file}")
            done
          done

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No APK outputs found for package ${{ matrix.package }}"
            exit 1
          fi

          cp -f "${files[@]}" "${artifact_dir}/"
          ls -lh "${artifact_dir}/"

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fastboop-overrides-${{ matrix.package }}
          path: out/${{ matrix.package }}/

  publish-and-smoke-check:
    needs:
      - resolve-build-matrix
      - build-overrides
    if: needs.resolve-build-matrix.outputs.has_packages == 'true'
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 120
    env:
      APK_REPO_BASE_URL: ${{ vars.APK_REPO_BASE_URL || 'https://pmos.samcday.com' }}
      APK_REPO_KEY_URL: ${{ vars.APK_REPO_KEY_URL || 'https://pmos.samcday.com/pmos.samcday.com.rsa.pub' }}
      APK_REPO_BUCKET: ${{ vars.APK_REPO_BUCKET || 'samcday-pmos' }}
      APK_REPO_S3_ENDPOINT: ${{ vars.APK_REPO_S3_ENDPOINT || 'https://s3.eu-central-003.backblazeb2.com' }}
      APK_REPO_S3_REGION: ${{ vars.APK_REPO_S3_REGION || 'eu-central-003' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download built package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: fastboop-overrides-*
          path: out/aarch64/
          merge-multiple: true

      - name: Validate downloaded payload
        run: |
          set -euo pipefail
          shopt -s nullglob
          apk_files=(out/aarch64/*.apk)
          if [ "${#apk_files[@]}" -eq 0 ]; then
            echo "No APKs downloaded from build artifacts"
            exit 1
          fi
          ls -lh out/aarch64/

      - name: Prepare signing key and canonical public key
        env:
          APK_REPO_SIGNING_KEY: ${{ secrets.APK_REPO_SIGNING_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${APK_REPO_SIGNING_KEY}" ]; then
            echo "APK_REPO_SIGNING_KEY is not set"
            exit 1
          fi

          signing_key_path="${RUNNER_TEMP}/pmos.samcday.com.rsa"
          printf "%s\n" "${APK_REPO_SIGNING_KEY}" > "${signing_key_path}"

          if ! grep -q "PRIVATE KEY" "${signing_key_path}"; then
            echo "APK_REPO_SIGNING_KEY is not a private key"
            exit 1
          fi

          chmod 0600 "${signing_key_path}"
          openssl rsa -in "${signing_key_path}" -pubout > out/aarch64/pmos.samcday.com.rsa.pub
          echo "APK_REPO_SIGNING_KEY_PATH=${signing_key_path}" >> "${GITHUB_ENV}"

      - name: Generate signed APKINDEX
        run: |
          set -euo pipefail

          docker run --rm \
            -v "${PWD}/out/aarch64:/repo" \
            -v "${APK_REPO_SIGNING_KEY_PATH}:/keys/pmos.samcday.com.rsa:ro" \
            alpine:3.20 \
            /bin/sh -euxc 'apk add --no-cache alpine-sdk >/dev/null; cd /repo; apk index --allow-untrusted -o APKINDEX.tar.gz ./*.apk; abuild-sign -k /keys/pmos.samcday.com.rsa APKINDEX.tar.gz'

      - name: Verify APKINDEX and APK signatures
        run: |
          set -euo pipefail

          verify_keys_dir="$(mktemp -d)"
          cp out/aarch64/pmos.samcday.com.rsa.pub "${verify_keys_dir}/"

          docker run --rm \
            -v "${PWD}/out/aarch64:/repo:ro" \
            -v "${verify_keys_dir}:/keys:ro" \
            alpine:3.20 \
            /bin/sh -euxc 'apk add --no-cache apk-tools-static >/dev/null; apk.static --keys-dir /keys verify /repo/APKINDEX.tar.gz; for apk in /repo/*.apk; do apk.static --keys-dir /keys verify "$apk"; done'

          rm -rf "${verify_keys_dir}"

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fastboop-overrides-aarch64
          path: out/aarch64/

      - name: Install AWS CLI
        if: github.event_name == 'push'
        run: |
          if ! command -v aws >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y awscli
          fi

      - name: Publish hosted APK repo
        if: github.event_name == 'push'
        env:
          APK_REPO_ACCESS_KEY_ID: ${{ secrets.APK_REPO_ACCESS_KEY_ID }}
          APK_REPO_SECRET_ACCESS_KEY: ${{ secrets.APK_REPO_SECRET_ACCESS_KEY }}
        run: bash .github/scripts/publish-apk-repo.sh out/aarch64

      - name: Smoke check hosted APK repo
        if: github.event_name == 'push'
        env:
          APK_REPO_DOCKER_PLATFORM: linux/arm64/v8
        run: |
          set -euo pipefail

          for attempt in 1 2 3 4 5; do
            if bash .github/scripts/smoke-check-apk-repo.sh; then
              exit 0
            fi

            if [ "${attempt}" -eq 5 ]; then
              echo "Smoke check failed after ${attempt} attempts"
              exit 1
            fi

            echo "Smoke check attempt ${attempt} failed; waiting 20s before retry"
            sleep 20
          done
